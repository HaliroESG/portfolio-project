name: Financial Data Sync

on:
  schedule:
    - cron: '0 9-22 * * 1-5'  # Stock and macro sync (hourly during market hours)
    - cron: '*/15 * * * *'     # News sync (every 15 minutes)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Monorepo: Toutes les opérations Python s'exécutent dans ./backend
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install wheel
          # On installe explicitement les libs scientifiques lourdes d'abord
          pip install scipy==1.15.1 statsmodels==0.14.4
          # On installe le reste via le fichier
          pip install -r requirements.txt

      - name: Sync Stock Data
        working-directory: ./backend
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          # ICI LA CORRECTION : On mappe le bon secret vers le bon nom de variable
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GSPREAD_SERVICE_ACCOUNT: ${{ secrets.GSPREAD_SERVICE_ACCOUNT }}
          GSHEET_NAME: ${{ secrets.GSHEET_NAME }}
        run: python bridge.py

      - name: Sync Macro Indicators
        working-directory: ./backend
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: python macro_sync.py

      - name: Sync News Feed
        working-directory: ./backend
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: python news_sync.py
